---
name: triggering tests and waiting for result
on:
  push:

jobs:
  test:
    name: Test
    timeout-minutes: 10

    runs-on: ubuntu-latest

    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"

      - name: get the check run id for each job
        run: |
          CHECK_SUITE_URL=$(curl -s -H "authorization: token ${{ secrets.ROBOT_TOKEN }}" https://api.github.com/repos/percona-platform/saas-ui/actions/runs/${GITHUB_RUN_ID} | jq -r '.check_suite_url')
          CHECK_RUN_ID=$(curl -s -H "authorization: token ${{ secrets.ROBOT_TOKEN }}" -H "Accept: application/vnd.github.antiope-preview+json" $CHECK_SUITE_URL/check-runs | jq '.check_runs[] | select(.name=="prcheck (ubuntu-latest)") | .id ')
          echo $CHECK_RUN_ID

      - name: dispatching a workflow
        run: |
          curl \
          -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.ROBOT_TOKEN }}" \
          https://api.github.com/repos/percona-platform/saas-ui/actions/workflows/test.yml/dispatches \
          -d '{
                "ref":"${{ github.ref }}",
                "inputs": {
                  "branch": "${{ github.ref }}",
                  "repo": "${{ github.repository }}",
                  "run_id": "${{ github.run_id }}"
                }
              }'

      - name: sleep
        run: sleep 5m
